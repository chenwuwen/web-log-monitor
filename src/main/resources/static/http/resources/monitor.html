<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Log</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <link rel="stylesheet" href="css/monitor.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body class="layui-layout-body">


    <div class="layui-row layui-col-space15" style="padding: 20px; background-color: #F2F2F2;">

        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    日志输出
                    <div class="layui-btn-group layuiadmin-btn-group">
                        <button class="layui-btn layui-btn-primary layui-btn-xs" onClick="clearLog()">
                            <i class="layui-icon layui-icon-delete"></i> 清空
                        </button>
                        <button class="layui-btn layui-btn-primary layui-btn-xs" onClick="downloadLog()">
                            <i class="layui-icon layui-icon-download-circle"></i>下载
                        </button>
                    </div>
                </div>

                <div id="web_log" class="layui-card-body layui-bg-black">
                    <div contenteditable="true" class="layui-bg-black log_container">

                    </div>
                </div>

            </div>
        </div>
    </div>


</body>

<script type="text/html" id="log_segment_html">
    <div>
        <span class="log_time"></span>
        <span class="log_level"></span>
        <span class="log_threadName"></span>
        <span class="log_className" style="color:#009688"></span>
        <span class="log_body"></span>

    </div>
</script>

<script src="layui/layui.all.js" charset="utf-8"></script>
<script src="js/jquery.min.js" charset="utf-8"></script>
<script src="js/utils.js" charset="utf-8"></script>
<script src="js/log.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script type="application/javascript">

    if (!!window.EventSource) {
        // web logger sse监听 使用 SSE 时，浏览器首先生成一个EventSource实例，向服务器发起连接。 withCredentials属性，表示是否一起发送 Cookie
        var source = new EventSource("push", {withCredentials: true});

        // EventSource实例的readyState属性，表明连接的当前状态。该属性只读，可以取以下值
        // 0：相当于常量EventSource.CONNECTING，表示连接还未建立，或者断线正在重连。
        // 1：相当于常量EventSource.OPEN，表示连接已经建立，可以接受数据。
        // 2：相当于常量EventSource.CLOSED，表示连接已断，且不会重连。
        console.log(source.readyState);

        // 连接一旦建立，就会触发open事件，可以在onopen属性定义回调函数
        source.onopen = function (event) {
            console.log("SSE建立连接");
        };

        // 客户端收到服务器发来的数据，就会触发message事件，可以在onmessage属性定义回调函数
        // 已经设置了textarea为readOnly,之所以没有设置为disabled是因为disabled不能复制,同时需要注意,接收的内容是需要追加到textarea中的
        source.onmessage = function (event) {
            console.log("SSE 服务端推送日志信息")
            console.log(event);
            let res = event.data
            console.log(typeof res);
            res = JSON.parse(res)
            let body = res['body']
            let timestamp = res['timestamp']
            let threadName = res['threadName']
            let className = res['className']
            let level = res['level']

            $("#log_segment_html .log_time").html(timestamp);

            $("#log_segment_html .log_level").html(level);
            if ("ERROR" == level) {
                $("#log_segment_html .log_level").addClass("level_error")
            } else {
                $("#log_segment_html .log_level").addClass("level_debug")
            }
            $("#log_segment_html .log_threadName").html("[" + threadName + "]")
            $("#log_segment_html .log_className").html(className)
            $("#log_segment_html .log_body").html(body)

            let log_html = $("#log_segment_html").html();
            console.log(log_html);
            $("#web_log").children("div").append(log_html)
            // 设置 div 默认滑动到底部
            $('#web_log .log_container').scrollTop($('#web_log .log_container')[0].scrollHeight);

        };

        // 如果发生通信错误（比如连接中断），就会触发error事件，可以在onerror属性定义回调函数
        source.onerror = function (event) {
            console.log("SSE通信发生错误,默认会自动重连,如果不需要自动重连,需要手动close掉");
            console.log(event);
            source.close()
        };
    } else {
        // 浏览器不支持 Server-Sent..
        console.log("当前浏览器不支持Server-Sent Event");
    }

</script>

</html>